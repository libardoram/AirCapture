name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build unsigned DMG
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake xcodegen

      - name: Build vendor library
        run: bash vendor/uxplay/build_lib.sh
        working-directory: ${{ github.workspace }}

      - name: Generate Xcode project
        run: xcodegen generate --spec project.yml
        working-directory: ${{ github.workspace }}/AirCapture

      - name: Build Release (unsigned)
        run: |
          SCRIPT_DIR="${{ github.workspace }}/scripts"
          REPO_DIR="${{ github.workspace }}"
          PROJECT_DIR="$REPO_DIR/AirCapture"
          BUILD_DIR="$REPO_DIR/build"

          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"

          xcodebuild \
            -project "$PROJECT_DIR/AirCapture.xcodeproj" \
            -scheme AirCapture \
            -configuration Release \
            -derivedDataPath "$BUILD_DIR/DerivedData" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

          cp -R "$BUILD_DIR/DerivedData/Build/Products/Release/AirCapture.app" "$BUILD_DIR/"

      - name: Create DMG
        run: bash scripts/create-dmg.sh

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: AirCapture v${{ steps.version.outputs.version }}
          body: |
            ## AirCapture v${{ steps.version.outputs.version }}

            ### Installation

            1. Download `AirCapture-${{ steps.version.outputs.version }}.dmg`
            2. Open the DMG and drag AirCapture to Applications
            3. Launch AirCapture from Applications

            > **Note:** This DMG is unsigned. If macOS blocks the app on first launch,
            > right-click AirCapture.app and choose Open, then confirm.

            ### Requirements
            - macOS 15.0 (Sequoia) or later
            - Apple Silicon (M1 or later)
          draft: true
          files: build/AirCapture-${{ steps.version.outputs.version }}.dmg
