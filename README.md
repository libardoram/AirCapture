# AirCapture

**Multi-stream AirPlay screen mirroring receiver and recorder for macOS**

AirCapture turns a Mac into a monitoring hub that receives simultaneous AirPlay screen mirrors from multiple iOS, iPadOS, or macOS devices — no MDM, no agents, no app install on sender devices. Students or participants simply use the standard AirPlay picker on their device.

![macOS](https://img.shields.io/badge/macOS-15.0%2B-blue)
![Swift](https://img.shields.io/badge/Swift-5-orange)
![Architecture](https://img.shields.io/badge/arch-Apple%20Silicon-black)
![License](https://img.shields.io/badge/license-GPL--3.0-blue)

---

## What it does

- Runs up to **30 independent AirPlay receiver slots** simultaneously, each advertised as a separate Bonjour service on your local network (e.g., `AirCapture-01`, `AirCapture-02`, ...)
- Displays all live streams in an **adaptive grid view** — double-click any tile to zoom in full-window
- **Records** each stream independently as an MP4, using a rolling consolidation strategy that keeps disk usage minimal throughout long sessions
- Optional **4-digit PIN** per receiver with automatic device blocking after failed attempts
- **Connection logging** with timestamps and device info, stored in Application Support

---

## Requirements

| | |
|---|---|
| macOS | 15.0 Sequoia or later |
| Processor | Apple Silicon (M1 or later) |
| RAM | 8 GB minimum; 16 GB recommended for 8+ streams |
| Storage | SSD recommended for recording |
| Network | 5 GHz Wi-Fi or Ethernet recommended |
| Xcode | 16.0 or later (to build from source) |
| Homebrew | Required for vendor library dependencies |

---

## Running the app

### From a release build

1. Download `AirCapture.dmg` from the releases page
2. Open the DMG and drag `AirCapture.app` to Applications
3. Launch AirCapture

### From source (debug)

```bash
# 1. Clone the repo
git clone https://github.com/yourusername/AirCapture.git
cd AirCapture

# 2. Install dependencies (required once)
brew install openssl@3 libplist cmake

# 3. Build the vendor library (required once, or after vendor changes)
cd vendor/uxplay
bash build_lib.sh
cd ../..

# 4. Generate the Xcode project (required once, or after project.yml changes)
cd AirCapture
xcodegen generate --spec project.yml

# 5. Open in Xcode and run
open AirCapture.xcodeproj
```

Hit **Run** in Xcode (`Cmd+R`) to build and launch the debug build.

> **Note:** LSP/SourceKit errors shown in editors outside Xcode (VS Code, etc.) for Swift files that reference C types are expected — the C bridging header is only indexed inside Xcode. The code compiles correctly.

---

## How to compile

### Debug build (Xcode)

Open `AirCapture/AirCapture.xcodeproj` and build the `AirCapture` scheme. The `Embed Libraries` post-compile script runs automatically and embeds OpenSSL and libplist into the app bundle.

### Release build (command line)

```bash
cd scripts
bash build-release.sh
```

This cleans the build folder, regenerates the Xcode project via XcodeGen, builds the `Release` configuration, copies the app to `build/AirCapture.app`, and verifies the code signature.

Output: `build/AirCapture.app`

---

## Project structure

```
AirCapture/
├── AirCapture/
│   ├── AirCapture.xcodeproj/       Xcode project (generated by XcodeGen)
│   ├── project.yml                 XcodeGen spec (source of truth for project settings)
│   ├── Sources/                    Swift source files
│   │   ├── AirCaptureApp.swift     App entry point, menu bar, window management
│   │   ├── ContentView.swift       Root view, toolbar, start/stop/record controls
│   │   ├── StreamManager.swift     Orchestrates all receiver slots, routing, recording
│   │   ├── AirPlayReceiver.swift   Swift wrapper around the UxPlay C library
│   │   ├── VideoDecoder.swift      VideoToolbox H.264 decoder, CVPixelBuffer callbacks
│   │   ├── StreamGridView.swift    Adaptive grid UI, per-tile pixel buffer rendering
│   │   ├── StreamZoomView.swift    Full-window zoom view for a single stream
│   │   ├── SnapshotRecorder.swift  Snapshot capture, JPEG encoding, rolling MP4 consolidation
│   │   ├── AppSettings.swift       Persistent settings via UserDefaults
│   │   ├── SettingsView.swift      Settings UI (slots, recording, PIN, quality)
│   │   ├── ConnectionLogger.swift  Connection event logging with auto-retention
│   │   ├── PINAttemptTracker.swift PIN enforcement and device blocking
│   │   ├── AboutView.swift         About screen
│   │   ├── HelpView.swift          Embedded help/documentation viewer
│   │   ├── Info.plist              App metadata
│   │   ├── AirCapture.entitlements Hardened runtime entitlements
│   │   └── AirCapture-Bridging-Header.h  C/Swift bridge for UxPlay
│   ├── Scripts/
│   │   └── embed_libraries.sh      Xcode post-build: embeds OpenSSL + libplist into bundle
│   └── Resources/                  App icons and assets
├── vendor/
│   └── uxplay/                     Vendored UxPlay AirPlay server library (C, GPL-3.0)
│       ├── build_lib.sh            Builds libuxplay_combined.a via CMake
│       ├── lib/                    UxPlay C source (raop, dnssd, playfair, llhttp)
│       └── build/                  CMake build output (static libs + headers)
├── scripts/                        Distribution scripts (see below)
├── PRD.md                          Product Requirements Document
├── QUICK_START.md                  5-minute setup guide
├── USER_GUIDE.md                   Full user documentation
└── SETTINGS_REFERENCE.md           Settings field reference
```

---

## Scripts

All scripts live in `scripts/`. They are meant to be run from that directory.

### `build-release.sh`

Builds a signed Release binary.

```bash
cd scripts
bash build-release.sh
```

Steps it runs:
1. Cleans `build/`
2. Runs `xcodegen generate` to regenerate the Xcode project
3. Builds the `Release` configuration via `xcodebuild`
4. Copies `AirCapture.app` to `build/`
5. Verifies the code signature with `codesign --deep --strict`

### `create-dmg.sh`

Packages the built app into a distributable DMG. Run after `build-release.sh`.

```bash
cd scripts
bash create-dmg.sh
```

Steps it runs:
1. Stages the app and an `/Applications` symlink
2. Creates a temporary HFS+ disk image
3. Arranges icons with an AppleScript Finder layout
4. Converts to a compressed UDZO DMG
5. Outputs `build/AirCapture-{version}.dmg`

### `notarize.sh`

Signs and notarizes the DMG with Apple. Run after `create-dmg.sh`.

```bash
cd scripts
bash notarize.sh
```

Requires notarization credentials stored in the keychain (see `setup-notarization.sh`). Submits to Apple via `xcrun notarytool`, waits for the result, and staples the ticket to the DMG on success.

### `setup-notarization.sh`

One-time setup to store your Apple notarization credentials in the macOS keychain.

```bash
APPLE_ID=your@apple.id TEAM_ID=YOURTEAMID bash setup-notarization.sh
```

Reads `APPLE_ID` and `TEAM_ID` from the environment (set by `distribute.sh` when run via the pipeline). You will also need an [app-specific password](https://support.apple.com/en-us/102654) from your Apple ID account.

### `distribute.sh`

Runs the full distribution pipeline in one command: build → DMG → notarize.

Set your credentials at the top of the script before running:

```bash
# Inside distribute.sh — edit these two lines:
APPLE_ID=your@apple.id
TEAM_ID=YOURTEAMID
```

Then run:

```bash
cd scripts
bash distribute.sh
```

`distribute.sh` exports `APPLE_ID` and `TEAM_ID` as environment variables so `notarize.sh` and `setup-notarization.sh` pick them up automatically — no need to edit any other script.

### `vendor/uxplay/build_lib.sh`

Builds the UxPlay C library from source using CMake. Run once after cloning, or whenever vendor sources change.

```bash
cd vendor/uxplay
bash build_lib.sh
```

Produces:
- `vendor/uxplay/build/libuxplay_combined.a` — combined static library (linked by Xcode)
- `vendor/uxplay/build/include/` — headers copied for the Swift bridging header

Requires CMake (`brew install cmake`) and Xcode command line tools.

### `AirCapture/Scripts/embed_libraries.sh`

Run automatically by Xcode as a post-compile build phase. Copies OpenSSL and libplist dylibs from Homebrew into the app bundle's `Contents/Frameworks/`, rewrites install names to `@rpath`, and re-signs them. This makes the app self-contained and portable.

---

## How recording works

### Why snapshots instead of direct video capture

The straightforward approach to recording an AirPlay stream is to pipe the incoming H.264 data directly to a file. That works fine for a single connection, but degrades significantly under load: when several streams are active simultaneously, the AirPlay protocol reduces image quality aggressively to keep up with bandwidth and CPU demands. Capturing that degraded stream directly to video means the degradation is permanently baked into the recording.

Snapshot-based recording sidesteps this problem. Instead of recording the compressed transport stream, AirCapture samples individual decoded frames at a chosen interval. Each frame is a full-resolution `CVPixelBuffer` taken after VideoToolbox has decoded it — the quality of that single frame is not affected by whatever compression the protocol was using in the seconds around it. Those frames are then re-encoded into an MP4 at a controlled bitrate by `AVAssetWriter`. The result is a video whose quality is determined by the settings you choose, not by how busy the network was at any given moment. At lower frame rates it also produces substantially smaller files than a continuous H.264 capture would.

### Recording pipeline

1. Each slot's `SnapshotRecorder` captures `CVPixelBuffer` frames from the live stream at a configurable interval (default: 0.2 fps / every 5 seconds, range: 0.25–60 fps)
2. Frames are encoded as JPEG and saved to a hidden `.images/` folder inside the session directory
3. Every N minutes (default: 5), accumulated JPEGs are encoded into an MP4 segment and the `.images/` folder is cleared
4. Each new segment is immediately merged into a single `{SlotName}_CONSOLIDATED.mp4` via `AVMutableComposition`, and the segment file is deleted
5. At any point during a session, at most 1–2 files exist per slot on disk

Recordings are organized as:

```
~/Documents/AirCapture Recordings/
└── 2026-02-20/
    └── My Session/
        ├── AirCapture-01/
        │   ├── .images/                        (hidden, cleared after each segment)
        │   └── AirCapture-01_CONSOLIDATED.mp4  (continuously updated)
        ├── AirCapture-02/
        │   └── AirCapture-02_CONSOLIDATED.mp4
        └── ...
```

Connection logs are at: `~/Library/Application Support/AirCapture/Logs/`

---

## Dependencies

| Library | Version | Purpose | License |
|---------|---------|---------|---------|
| [UxPlay](https://github.com/FDH2/UxPlay) | vendored | AirPlay server (RTSP, H.264, Bonjour, FairPlay) | GPL-3.0 |
| OpenSSL | 3.x (Homebrew) | Cryptographic operations for AirPlay pairing | Apache-2.0 |
| libplist | 2.x (Homebrew) | Apple property list parsing | LGPL-2.1 |

> Because UxPlay is GPL-3.0, AirCapture is also distributed under GPL-3.0.

---

## Troubleshooting

**Devices can't find AirCapture in the AirPlay picker**
- Ensure the Mac and sender device are on the same Wi-Fi network
- Check System Settings → Network → Firewall — allow incoming connections for AirCapture
- If macOS's built-in AirPlay Receiver is enabled (System Settings → General → AirDrop & Handoff), it may conflict — disable it while using AirCapture

**Apple Silicon Mac shows as connected but displays a black screen**
- Fixed in v1.3. Make sure you are on the latest version.
- Root cause was the `passwd` callback being registered unconditionally, triggering an unexpected HTTP 401 during RTSP negotiation that macOS Sequoia does not retry.

**High disk usage during recording**
- Lower the snapshot frame rate in Settings → Recording (biggest impact)
- Use Low or Medium quality preset
- Default 0.2 fps ≈ 2.4 MB/min per stream

**Connection drops or video stutters**
- Move closer to the Wi-Fi router or switch to a wired connection
- Reduce the number of active streams
- Check that no other process is heavily using the network interface

---

## Contributing

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/my-feature`
3. Rebuild vendor libraries if you changed anything under `vendor/`: `bash vendor/uxplay/build_lib.sh`
4. Regenerate the Xcode project if you changed `project.yml`: `xcodegen generate --spec AirCapture/project.yml`
5. Test with at least 2–4 simultaneous streams before submitting
6. Open a pull request

---

## License

GPL-3.0 — see [LICENSE](LICENSE). This project incorporates UxPlay, which is GPL-3.0 licensed.

---

## Acknowledgments

- [UxPlay](https://github.com/FDH2/UxPlay) — open-source AirPlay server implementation that powers the receiver engine
- [OpenSSL](https://openssl.org) — cryptographic library
- [libplist](https://libimobiledevice.org) — Apple property list handling

---

*This README and the distribution scripts in `scripts/` were written with the assistance of an AI coding agent.*
